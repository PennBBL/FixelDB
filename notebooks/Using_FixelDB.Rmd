---
title: "Fixel-Based Analysis Using HDF5 Files"
output: html_notebook
---

```{r}
library(here)
library(FixelArray)
library(tidyverse)
```


# Quickstart

TODO: Blah blah blah walkthrough

# Under the Hood

Fixel-based analysis in R is an interesting approach to studying diffusion in the brain. Just like voxel-based analysis, fixels and the interactions between them may describe useful information about neuroanatomy, development patterns, or pathology.

## Fixel Data Structure

Describe fixel data as output by mrtrix

## HDF5

R is an excellent tool for tidy data analysis. However, because of the complexity and size of fixel data, reading fixel data into memory is not an efficient strategy. Instead, we use the `HDF5Array` package to analyse data on-disk. This saves computational space in the R environment and allows for complex data to be represented in a single hierarchical file format. `HDF5Array` is an extension of the `DelayedArray` package that implements analysis on-disk data in R.

## `.mif` to `.h5`

R currently does not handle `.mif` files generated by mrtrix, but Python does. Since we only need Python for the transformation of data from `.mif` to `.h5`, we containerise a Python script that does this work for us, freeing up the R user from having to fiddle with Python environments and packages -- everything is provided in the container. The only requirement, therefore, is to have Docker installed and running.

Here is the python script that generates a `.h5` fixel database:

```{r, comment=''}
cat(readLines(here('fixelarray/fixels.py')), sep = '\n')
```

Again, the R user need not worry about any of this, since the Docker image comes ready to execute this in full.

This script is executed in the Docker container by running the following:

```{bash}
echo docker run blah
```

This is packaged in the function `create_fixel_file()`, which returns the path to the newly processed fixel data in HDF5 format:

```{r}
index_file = here('data/ZAPR01_Fixels/FD/index.mif')
directions_file = here('data/ZAPR01_Fixels/FD/directions.mif')
cohort_file = here('data/ZAPR01_Fixels/fd_inputs.csv')

# fpath <- create_fixelDB(index_file, directions_file, cohort_file)

fpath <- here('data', 'fixels.h5')

fpath
```

## Reading in Fixel Data

You can read in the fixel data with `FixelArray(fpath)`

```{r}
my_fixel_data <- FixelArray(here('data', 'fixels.h5'), c("FD"))
my_fixel_data
```

We can see that although the dimensions of these datasets is large, the object itself is small:

```{r}
object.size(my_fixel_data)
```

So, in order to get directions at a single fixel, use `fixels(data)[rowindex, columnindex]`:

```{r}
i <- 10000
fixels(my_fixel_data)[i,]
```

To get the value of the scalars at this fixel, use `scalars(data, scalar_name)[index]`

```{r}
scalars(my_fixel_data, "FD")[i,]
```


